(function(){var t,e,n,o,i,r,s,a,u,h,l,p,d,c,f,g,m,y,v,_,w,T,b,E,A,N,C,k,x,F,O,S=[].slice,P={}.hasOwnProperty,D=function(t,e){for(var n in e)P.call(e,n)&&(t[n]=e[n]);function o(){this.constructor=t}return o.prototype=e.prototype,t.prototype=new o,t.__super__=e.prototype,t},R=function(t,e){return function(){return t.apply(e,arguments)}},H=[].indexOf||function(t){for(var e=0,n=this.length;e<n;e++)if(e in this&&this[e]===t)return e;return-1};if(y=function(e){return this.map(function(){var n,o,i,r;for(i="",n=this;(null!=n?n.nodeType:void 0)===Node.ELEMENT_NODE&&n!==e;)r=n.tagName.replace(":","\\:"),o="["+(o=t(n.parentNode).children(r).index(n)+1)+"]",i="/"+n.tagName.toLowerCase()+o+i,n=n.parentNode;return i}).get()},v=function(t){var e,n,o;return e=function(t){return c(t)+"["+f(t)+"]"},o=t,n=function(t){var n;for(n="";t!==o;){if(null==t)throw new Error("Called getPathTo on a node which was not a descendant of @rootNode. "+o);n=e(t)+"/"+n,t=t.parentNode}return n=(n="/"+n).replace(/\/$/,"")},this.map(function(){return n(this)}).get()},h=function(t,e,n){var o,i,r,s,a;if(!t.hasChildNodes())throw new Error("XPath error: node has no children!");for(r=0,s=0,a=(i=t.childNodes).length;s<a;s++)if(o=i[s],c(o)===e&&(r+=1)===n)return o;throw new Error("XPath error: wanted child not found.")},c=function(t){var e;switch(e=t.nodeName.toLowerCase()){case"#text":return"text()";case"#comment":return"comment()";case"#cdata-section":return"cdata-section()";default:return e}},f=function(t){var e,n;for(e=0,n=t;n;)n.nodeName===t.nodeName&&e++,n=n.previousSibling;return e},g=null,"undefined"!=typeof Gettext&&null!==Gettext?(w=new Gettext({domain:"annotator"}),g=function(t){return w.gettext(t)}):g=function(t){return t},k=function(t){return g(t)},("undefined"!=typeof jQuery&&null!==jQuery&&null!=(N=jQuery.fn)?N.jquery:void 0)||console.error(k("Annotator requires jQuery: have you included lib/vendor/jquery.js?")),JSON&&JSON.parse&&JSON.stringify||console.error(k("Annotator requires a JSON implementation: have you included lib/vendor/json2.js?")),t=jQuery,(r={}).flatten=function(e){var n;return(n=function(e){var o,i,r,s;for(i=[],r=0,s=e.length;r<s;r++)o=e[r],i=i.concat(o&&t.isArray(o)?n(o):o);return i})(e)},r.contains=function(t,e){var n;for(n=e;null!=n;){if(n===t)return!0;n=n.parentNode}return!1},r.getTextNodes=function(t){var e;return e=function(t){var n;if(t&&t.nodeType!==Node.TEXT_NODE){if(n=[],t.nodeType!==Node.COMMENT_NODE)for(t=t.lastChild;t;)n.push(e(t)),t=t.previousSibling;return n.reverse()}return t},t.map(function(){return r.flatten(e(this))})},r.getLastTextNodeUpTo=function(t){var e;switch(t.nodeType){case Node.TEXT_NODE:return t;case Node.ELEMENT_NODE:if(null!=t.lastChild&&null!=(e=r.getLastTextNodeUpTo(t.lastChild)))return e}return null!=(t=t.previousSibling)?r.getLastTextNodeUpTo(t):null},r.getFirstTextNodeNotBefore=function(t){var e;switch(t.nodeType){case Node.TEXT_NODE:return t;case Node.ELEMENT_NODE:if(null!=t.firstChild&&null!=(e=r.getFirstTextNodeNotBefore(t.firstChild)))return e}return null!=(t=t.nextSibling)?r.getFirstTextNodeNotBefore(t):null},r.readRangeViaSelection=function(t){var e;return(e=r.getGlobal().getSelection()).removeAllRanges(),e.addRange(t.toRange()),e.toString()},r.xpathFromNode=function(t,e){var n;try{n=y.call(t,e)}catch(o){o,console.log("jQuery-based XPath construction failed! Falling back to manual."),n=v.call(t,e)}return n},r.nodeFromXPath=function(t,e){var n,o,i,r,s,a,u;for(i=e,s=0,a=(r=t.substring(1).split("/")).length;s<a;s++)o=(u=r[s].split("["))[0],n=null!=(n=u[1])?parseInt((null!=n?n.split("]"):void 0)[0]):1,i=h(i,o.toLowerCase(),n);return i},r.escape=function(t){return t.replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},r.uuid=(x=0,function(){return x++}),r.getGlobal=function(){return function(){return this}()},r.maxZIndex=function(e){var n,o;return n=function(){var n,i,r;for(r=[],n=0,i=e.length;n<i;n++)o=e[n],"static"===t(o).css("position")?r.push(-1):r.push(parseInt(t(o).css("z-index"),10)||-1);return r}(),Math.max.apply(Math,n)},r.mousePosition=function(e,n){var o,i;return"absolute"!==(i=t(n).css("position"))&&"fixed"!==i&&"relative"!==i&&(n=t(n).offsetParent()[0]),o=t(n).offset(),{top:e.pageY-o.top,left:e.pageX-o.left}},r.preventEventDefault=function(t){return null!=t&&"function"==typeof t.preventDefault?t.preventDefault():void 0},p=["log","debug","info","warn","exception","assert","dir","dirxml","trace","group","groupEnd","groupCollapsed","time","timeEnd","profile","profileEnd","count","clear","table","error","notifyFirebug","firebug","userObjects"],"undefined"!=typeof console&&null!==console)for(null==console.group&&(console.group=function(t){return console.log("GROUP: ",t)}),null==console.groupCollapsed&&(console.groupCollapsed=console.group),T=0,E=p.length;T<E;T++)l=p[T],null==console[l]&&(console[l]=function(){return console.log(k("Not implemented:")+" console."+name)});else{for(this.console={},b=0,A=p.length;b<A;b++)l=p[b],this.console[l]=function(){};this.console.error=function(){var t;return t=1<=arguments.length?S.call(arguments,0):[],alert("ERROR: "+t.join(", "))},this.console.warn=function(){var t;return t=1<=arguments.length?S.call(arguments,0):[],alert("WARNING: "+t.join(", "))}}(n=function(){function e(e,n){this.options=t.extend(!0,{},this.options,n),this.element=t(e),this._closures={},this.on=this.subscribe,this.addEvents()}return e.prototype.events={},e.prototype.options={},e.prototype.element=null,e.prototype.addEvents=function(){var t,n,o,i,r;for(r=[],n=0,o=(i=e._parseEvents(this.events)).length;n<o;n++)t=i[n],r.push(this._addEvent(t.selector,t.event,t.functionName));return r},e.prototype.removeEvents=function(){var t,n,o,i,r;for(r=[],n=0,o=(i=e._parseEvents(this.events)).length;n<o;n++)t=i[n],r.push(this._removeEvent(t.selector,t.event,t.functionName));return r},e.prototype._addEvent=function(t,n,o){var i,r;return r=this,i=function(){return r[o].apply(r,arguments)},""===t&&e._isCustomEvent(n)?this.subscribe(n,i):this.element.delegate(t,n,i),this._closures[t+"/"+n+"/"+o]=i,this},e.prototype._removeEvent=function(t,n,o){var i;return i=this._closures[t+"/"+n+"/"+o],""===t&&e._isCustomEvent(n)?this.unsubscribe(n,i):this.element.undelegate(t,n,i),delete this._closures[t+"/"+n+"/"+o],this},e.prototype.publish=function(){return this.element.triggerHandler.apply(this.element,arguments),this},e.prototype.subscribe=function(e,n){var o;return(o=function(){return n.apply(this,[].slice.call(arguments,1))}).guid=n.guid=t.guid+=1,this.element.bind(e,o),this},e.prototype.unsubscribe=function(){return this.element.unbind.apply(this.element,arguments),this},e}())._parseEvents=function(t){var e,n,o,i,r,s,a;for(i in n=[],t)o=t[i],r=2<=(a=i.split(" ")).length?S.call(a,0,s=a.length-1):(s=0,[]),e=a[s++],n.push({selector:r.join(" "),event:e,functionName:o});return n},n.natives=(O=function(){var t,e;for(F in e=[],t=jQuery.event.special)P.call(t,F)&&(t[F],e.push(F));return e}(),"blur focus focusin focusout load resize scroll unload click dblclick\nmousedown mouseup mousemove mouseover mouseout mouseenter mouseleave\nchange select submit keydown keypress keyup error".split(/[^a-z]+/).concat(O)),n._isCustomEvent=function(e){return e=e.split(".")[0],-1===t.inArray(e,n.natives)},(i={}).sniff=function(t){return null!=t.commonAncestorContainer?new i.BrowserRange(t):"string"==typeof t.start?new i.SerializedRange(t):t.start&&"object"==typeof t.start?new i.NormalizedRange(t):(console.error(k("Could not sniff range type")),!1)},i.nodeFromXPath=function(e,n){var o,i,s,a,u;return null==n&&(n=document),i=function(t,e){null==e&&(e=null);try{return document.evaluate("."+t,n,e,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}catch(e){return e,console.log("XPath evaluation failed."),console.log("Trying fallback..."),r.nodeFromXPath(t,n)}},t.isXMLDoc(document.documentElement)?(o=document.createNSResolver(null===document.ownerDocument?document.documentElement:document.ownerDocument.documentElement),(a=i(e,o))||(e=function(){var t,n,o,i;for(i=[],t=0,n=(o=e.split("/")).length;t<n;t++)(u=o[t])&&-1===u.indexOf(":")?i.push(u.replace(/^([a-z]+)/,"xhtml:$1")):i.push(u);return i}().join("/"),s=document.lookupNamespaceURI(null),a=i(e,o=function(t){return"xhtml"===t?s:document.documentElement.getAttribute("xmlns:"+t)})),a):i(e)},i.RangeError=function(t){function e(t,n,o){this.type=t,this.message=n,this.parent=null!=o?o:null,e.__super__.constructor.call(this,this.message)}return D(e,t),e}(Error),i.BrowserRange=function(){function t(t){this.commonAncestorContainer=t.commonAncestorContainer,this.startContainer=t.startContainer,this.startOffset=t.startOffset,this.endContainer=t.endContainer,this.endOffset=t.endOffset}return t.prototype.normalize=function(t){var e,n,o,s;if(this.tainted)return console.error(k("You may only call normalize() once on a BrowserRange!")),!1;if(this.tainted=!0,s={},this.startContainer.nodeType===Node.ELEMENT_NODE?(s.start=r.getFirstTextNodeNotBefore(this.startContainer.childNodes[this.startOffset]),s.startOffset=0):(s.start=this.startContainer,s.startOffset=this.startOffset),this.endContainer.nodeType===Node.ELEMENT_NODE){if(null!=(n=this.endContainer.childNodes[this.endOffset])){for(e=n;null!=e&&e.nodeType!==Node.TEXT_NODE;)e=e.firstChild;null!=e&&(s.end=e,s.endOffset=0)}null==s.end&&(n=this.endContainer.childNodes[this.endOffset-1],s.end=r.getLastTextNodeUpTo(n),s.endOffset=s.end.nodeValue.length)}else s.end=this.endContainer,s.endOffset=this.endOffset;for(o={},s.startOffset>0?s.start.nodeValue.length>s.startOffset?o.start=s.start.splitText(s.startOffset):o.start=s.start.nextSibling:o.start=s.start,s.start===s.end?(o.start.nodeValue.length>s.endOffset-s.startOffset&&o.start.splitText(s.endOffset-s.startOffset),o.end=o.start):(s.end.nodeValue.length>s.endOffset&&s.end.splitText(s.endOffset),o.end=s.end),o.commonAncestor=this.commonAncestorContainer;o.commonAncestor.nodeType!==Node.ELEMENT_NODE;)o.commonAncestor=o.commonAncestor.parentNode;return new i.NormalizedRange(o)},t.prototype.serialize=function(t,e){return this.normalize(t).serialize(t,e)},t}(),i.NormalizedRange=function(){function e(t){this.commonAncestor=t.commonAncestor,this.start=t.start,this.end=t.end}return e.prototype.normalize=function(t){return this},e.prototype.limit=function(e){var n,o,i,r,s,a;if(!(n=t.grep(this.textNodes(),function(n){return n.parentNode===e||t.contains(e,n.parentNode)})).length)return null;for(this.start=n[0],this.end=n[n.length-1],i=t(this.start).parents(),r=0,s=(a=t(this.end).parents()).length;r<s;r++)if(o=a[r],-1!==i.index(o)){this.commonAncestor=o;break}return this},e.prototype.serialize=function(e,n){var o,s,a;return a=(s=function(o,i){var s,a,u,h,l,p,d;for(u=n?t(o).parents(":not("+n+")").eq(0):t(o).parent(),l=r.xpathFromNode(u,e)[0],a=0,p=0,d=(s=(h=r.getTextNodes(u)).slice(0,h.index(o))).length;p<d;p++)a+=s[p].nodeValue.length;return i?[l,a+o.nodeValue.length]:[l,a]})(this.start),o=s(this.end,!0),new i.SerializedRange({start:a[0],end:o[0],startOffset:a[1],endOffset:o[1]})},e.prototype.text=function(){var t;return function(){var e,n,o,i;for(i=[],e=0,n=(o=this.textNodes()).length;e<n;e++)t=o[e],i.push(t.nodeValue);return i}.call(this).join("")},e.prototype.textNodes=function(){var e,n,o,i;return n=(i=[(o=r.getTextNodes(t(this.commonAncestor))).index(this.start),o.index(this.end)])[0],e=i[1],t.makeArray(o.slice(n,+e+1||9e9))},e.prototype.toRange=function(){var t;return(t=document.createRange()).setStartBefore(this.start),t.setEndAfter(this.end),t},e}(),i.SerializedRange=function(){function e(t){this.start=t.start,this.startOffset=t.startOffset,this.end=t.end,this.endOffset=t.endOffset}return e.prototype.normalize=function(e){var n,o,s,a,u,h,l,p,d,c,f,g,m,y;for(h={},d=0,f=(m=["start","end"]).length;d<f;d++){u=m[d];try{a=i.nodeFromXPath(this[u],e)}catch(t){throw o=t,new i.RangeError(u,"Error while finding "+u+" node: "+this[u]+": "+o,o)}if(!a)throw new i.RangeError(u,"Couldn't find "+u+" node: "+this[u]);for(s=0,l=this[u+"Offset"],"end"===u&&l--,c=0,g=(y=r.getTextNodes(t(a))).length;c<g;c++){if(s+(p=y[c]).nodeValue.length>l){h[u+"Container"]=p,h[u+"Offset"]=this[u+"Offset"]-s;break}s+=p.nodeValue.length}if(null==h[u+"Offset"])throw new i.RangeError(u+"offset","Couldn't find offset "+this[u+"Offset"]+" in element "+this[u])}return n=null==document.compareDocumentPosition?function(t,e){return t.contains(e)}:function(t,e){return 16&t.compareDocumentPosition(e)},t(h.startContainer).parents().each(function(){if(n(this,h.endContainer))return h.commonAncestorContainer=this,!1}),new i.BrowserRange(h).normalize(e)},e.prototype.serialize=function(t,e){return this.normalize(t).serialize(t,e)},e.prototype.toObject=function(){return{start:this.start,startOffset:this.startOffset,end:this.end,endOffset:this.endOffset}},e}(),_=this.Annotator,(e=function(e){function o(e,n){if(this.onDeleteAnnotation=R(this.onDeleteAnnotation,this),this.onEditAnnotation=R(this.onEditAnnotation,this),this.onAdderClick=R(this.onAdderClick,this),this.onAdderMousedown=R(this.onAdderMousedown,this),this.onHighlightMouseover=R(this.onHighlightMouseover,this),this.checkForEndSelection=R(this.checkForEndSelection,this),this.checkForStartSelection=R(this.checkForStartSelection,this),this.clearViewerHideTimer=R(this.clearViewerHideTimer,this),this.startViewerHideTimer=R(this.startViewerHideTimer,this),this.showViewer=R(this.showViewer,this),this.onEditorSubmit=R(this.onEditorSubmit,this),this.onEditorHide=R(this.onEditorHide,this),this.showEditor=R(this.showEditor,this),o.__super__.constructor.apply(this,arguments),this.plugins={},!o.supported())return this;this.options.readOnly||this._setupDocumentEvents(),this._setupWrapper()._setupViewer()._setupEditor(),this._setupDynamicStyle(),this.adder=t(this.html.adder).appendTo(this.wrapper).hide(),o._instances.push(this)}return D(o,n),o.prototype.events={".annotator-adder button click":"onAdderClick",".annotator-adder button mousedown":"onAdderMousedown",".annotator-hl mouseover":"onHighlightMouseover",".annotator-hl mouseout":"startViewerHideTimer"},o.prototype.html={adder:'<div class="annotator-adder"><button>'+k("Annotate")+"</button></div>",wrapper:'<div class="annotator-wrapper"></div>'},o.prototype.options={readOnly:!1},o.prototype.plugins={},o.prototype.editor=null,o.prototype.viewer=null,o.prototype.selectedRanges=null,o.prototype.mouseIsDown=!1,o.prototype.ignoreMouseup=!1,o.prototype.viewerHideTimer=null,o.prototype._setupWrapper=function(){return this.wrapper=t(this.html.wrapper),this.element.find("script").remove(),this.element.wrapInner(this.wrapper),this.wrapper=this.element.find(".annotator-wrapper"),this},o.prototype._setupViewer=function(){var e;return this.viewer=new o.Viewer({readOnly:this.options.readOnly}),this.viewer.hide().on("edit",this.onEditAnnotation).on("delete",this.onDeleteAnnotation).addField({load:(e=this,function(n,o){return o.text?t(n).html(r.escape(o.text)):t(n).html("<i>"+k("No Comment")+"</i>"),e.publish("annotationViewerTextField",[n,o])})}).element.appendTo(this.wrapper).bind({mouseover:this.clearViewerHideTimer,mouseout:this.startViewerHideTimer}),this},o.prototype._setupEditor=function(){return this.editor=new o.Editor,this.editor.hide().on("hide",this.onEditorHide).on("save",this.onEditorSubmit).addField({type:"textarea",label:k("Comments")+"…",load:function(e,n){return t(e).find("textarea").val(n.text||"")},submit:function(e,n){return n.text=t(e).find("textarea").val()}}),this.editor.element.appendTo(this.wrapper),this},o.prototype._setupDocumentEvents=function(){return t(document).bind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection}),this},o.prototype._setupDynamicStyle=function(){var e,n,o,i;return(o=t("#annotator-dynamic-style")).length||(o=t('<style id="annotator-dynamic-style"></style>').appendTo(document.head)),n="*"+function(){var t,e,n,o;for(o=[],t=0,e=(n=["adder","outer","notice","filter"]).length;t<e;t++)i=n[t],o.push(":not(.annotator-"+i+")");return o}().join(""),e=r.maxZIndex(t(document.body).find(n)),e=Math.max(e,1e3),o.text([".annotator-adder, .annotator-outer, .annotator-notice {","  z-index: "+(e+20)+";","}",".annotator-filter {","  z-index: "+(e+10)+";","}"].join("\n")),this},o.prototype.destroy=function(){var e,n,i;for(n in t(document).unbind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection}),t("#annotator-dynamic-style").remove(),this.adder.remove(),this.viewer.destroy(),this.editor.destroy(),this.wrapper.find(".annotator-hl").each(function(){return t(this).contents().insertBefore(this),t(this).remove()}),this.wrapper.contents().insertBefore(this.wrapper),this.wrapper.remove(),this.element.data("annotator",null),i=this.plugins)i[n],this.plugins[n].destroy();if(this.removeEvents(),-1!==(e=o._instances.indexOf(this)))return o._instances.splice(e,1)},o.prototype.getSelectedRanges=function(){var e,n,o,s,a,u,h,l,p;for(h=r.getGlobal().getSelection(),a=[],u=[],h.isCollapsed||(a=function(){var t,r,a;for(a=[],n=t=0,r=h.rangeCount;0<=r?t<r:t>r;n=0<=r?++t:--t)s=h.getRangeAt(n),e=new i.BrowserRange(s),null===(o=e.normalize().limit(this.wrapper[0]))&&u.push(s),a.push(o);return a}.call(this),h.removeAllRanges()),l=0,p=u.length;l<p;l++)s=u[l],h.addRange(s);return t.grep(a,function(t){return t&&h.addRange(t.toRange()),t})},o.prototype.createAnnotation=function(){var t;return t={},this.publish("beforeAnnotationCreated",[t]),t},o.prototype.setupAnnotation=function(e){var n,o,r,s,a,u,h,l,p,d;for(a=this.wrapper[0],e.ranges||(e.ranges=this.selectedRanges),r=[],u=0,l=(d=e.ranges).length;u<l;u++){s=d[u];try{r.push(i.sniff(s).normalize(a))}catch(t){if(!((n=t)instanceof i.RangeError))throw n;this.publish("rangeNormalizeFail",[e,s,n])}}for(e.quote=[],e.ranges=[],e.highlights=[],h=0,p=r.length;h<p;h++)o=r[h],e.quote.push(t.trim(o.text())),e.ranges.push(o.serialize(this.wrapper[0],".annotator-hl")),t.merge(e.highlights,this.highlightRange(o));return e.quote=e.quote.join(" / "),t(e.highlights).data("annotation",e),e},o.prototype.updateAnnotation=function(t){return this.publish("beforeAnnotationUpdated",[t]),this.publish("annotationUpdated",[t]),t},o.prototype.deleteAnnotation=function(e){var n,o,i,r;if(null!=e.highlights)for(o=0,i=(r=e.highlights).length;o<i;o++)null!=(n=r[o]).parentNode&&(n.childNodes[0],t(n).replaceWith(n.childNodes));return this.publish("annotationDeleted",[e]),e},o.prototype.loadAnnotations=function(t){var e,n,o;return null==t&&(t=[]),o=this,n=function(t){var i,r,s,a;for(null==t&&(t=[]),s=0,a=(r=t.splice(0,10)).length;s<a;s++)i=r[s],o.setupAnnotation(i);return t.length>0?setTimeout(function(){return n(t)},10):o.publish("annotationsLoaded",[e])},e=t.slice(),n(t),this},o.prototype.dumpAnnotations=function(){return this.plugins.Store?this.plugins.Store.dumpAnnotations():(console.warn(k("Can't dump annotations without Store plugin.")),!1)},o.prototype.highlightRange=function(e,n){var o,i,r,s,a,u,h;for(null==n&&(n="annotator-hl"),r=/^\s*$/,o=t("<span class='"+n+"'></span>"),h=[],s=0,a=(u=e.textNodes()).length;s<a;s++)i=u[s],r.test(i.nodeValue)||h.push(t(i).wrapAll(o).parent().show()[0]);return h},o.prototype.highlightRanges=function(e,n){var o,i,r,s;for(null==n&&(n="annotator-hl"),o=[],r=0,s=e.length;r<s;r++)i=e[r],t.merge(o,this.highlightRange(i,n));return o},o.prototype.addPlugin=function(t,e){var n,i;return this.plugins[t]?console.error(k("You cannot have more than one instance of any plugin.")):"function"==typeof(n=o.Plugin[t])?(this.plugins[t]=new n(this.element[0],e),this.plugins[t].annotator=this,"function"==typeof(i=this.plugins[t]).pluginInit&&i.pluginInit()):console.error(k("Could not load ")+t+k(" plugin. Have you included the appropriate <script> tag?")),this},o.prototype.showEditor=function(t,e){return this.editor.element.css(e),this.editor.load(t),this.publish("annotationEditorShown",[this.editor,t]),this},o.prototype.onEditorHide=function(){return this.publish("annotationEditorHidden",[this.editor]),this.ignoreMouseup=!1},o.prototype.onEditorSubmit=function(t){return this.publish("annotationEditorSubmit",[this.editor,t])},o.prototype.showViewer=function(t,e){return this.viewer.element.css(e),this.viewer.load(t),this.publish("annotationViewerShown",[this.viewer,t])},o.prototype.startViewerHideTimer=function(){if(!this.viewerHideTimer)return this.viewerHideTimer=setTimeout(this.viewer.hide,250)},o.prototype.clearViewerHideTimer=function(){return clearTimeout(this.viewerHideTimer),this.viewerHideTimer=!1},o.prototype.checkForStartSelection=function(t){return t&&this.isAnnotator(t.target)||this.startViewerHideTimer(),this.mouseIsDown=!0},o.prototype.checkForEndSelection=function(e){var n,o,i,s;if(this.mouseIsDown=!1,!this.ignoreMouseup){for(this.selectedRanges=this.getSelectedRanges(),o=0,i=(s=this.selectedRanges).length;o<i;o++)if(n=s[o].commonAncestor,t(n).hasClass("annotator-hl")&&(n=t(n).parents("[class!=annotator-hl]")[0]),this.isAnnotator(n))return;return e&&this.selectedRanges.length?this.adder.css(r.mousePosition(e,this.wrapper[0])).show():this.adder.hide()}},o.prototype.isAnnotator=function(e){return!!t(e).parents().addBack().filter("[class^=annotator-]").not(this.wrapper).length},o.prototype.onHighlightMouseover=function(e){var n;return this.clearViewerHideTimer(),!this.mouseIsDown&&!this.viewer.isShown()&&(n=t(e.target).parents(".annotator-hl").addBack().map(function(){return t(this).data("annotation")}),this.showViewer(t.makeArray(n),r.mousePosition(e,this.wrapper[0])))},o.prototype.onAdderMousedown=function(t){return null!=t&&t.preventDefault(),this.ignoreMouseup=!0},o.prototype.onAdderClick=function(e){var n,o,i,r,s,a;return null!=e&&e.preventDefault(),r=this.adder.position(),this.adder.hide(),n=this.setupAnnotation(this.createAnnotation()),t(n.highlights).addClass("annotator-hl-temporary"),a=this,s=function(){return i(),t(n.highlights).removeClass("annotator-hl-temporary"),a.publish("annotationCreated",[n])},o=function(t){return function(){return i(),t.deleteAnnotation(n)}}(this),i=function(t){return function(){return t.unsubscribe("annotationEditorHidden",o),t.unsubscribe("annotationEditorSubmit",s)}}(this),this.subscribe("annotationEditorHidden",o),this.subscribe("annotationEditorSubmit",s),this.showEditor(n,r)},o.prototype.onEditAnnotation=function(t){var e,n,o,i;return n=this.viewer.element.position(),i=this,o=function(){return e(),i.updateAnnotation(t)},e=function(t){return function(){return t.unsubscribe("annotationEditorHidden",e),t.unsubscribe("annotationEditorSubmit",o)}}(this),this.subscribe("annotationEditorHidden",e),this.subscribe("annotationEditorSubmit",o),this.viewer.hide(),this.showEditor(t,n)},o.prototype.onDeleteAnnotation=function(t){return this.viewer.hide(),this.deleteAnnotation(t)},o}()).Plugin=function(t){function e(t,n){e.__super__.constructor.apply(this,arguments)}return D(e,n),e.prototype.pluginInit=function(){},e.prototype.destroy=function(){return this.removeEvents()},e}(),null==(null!=(C=(d=r.getGlobal()).document)?C.evaluate:void 0)&&t.getScript("http://assets.annotateit.org/vendor/xpath.min.js"),null==d.getSelection&&t.getScript("http://assets.annotateit.org/vendor/ierange.min.js"),null==d.JSON&&t.getScript("http://assets.annotateit.org/vendor/json2.min.js"),null==d.Node&&(d.Node={ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12}),e.$=t,e.Delegator=n,e.Range=i,e.Util=r,e._instances=[],e._t=k,e.supported=function(){return function(){return!!this.getSelection}()},e.noConflict=function(){return r.getGlobal().Annotator=_,this},t.fn.annotator=function(n){var o;return o=Array.prototype.slice.call(arguments,1),this.each(function(){var i;return(i=t.data(this,"annotator"))?n&&i[n].apply(i,o):(i=new e(this,n),t.data(this,"annotator",i))})},this.Annotator=e,e.Widget=function(o){function i(n,o){i.__super__.constructor.apply(this,arguments),this.classes=t.extend({},e.Widget.prototype.classes,this.classes)}return D(i,n),i.prototype.classes={hide:"annotator-hide",invert:{x:"annotator-invert-x",y:"annotator-invert-y"}},i.prototype.destroy=function(){return this.removeEvents(),this.element.remove()},i.prototype.checkOrientation=function(){var n,o,i,r,s;return this.resetOrientation(),s=t(e.Util.getGlobal()),o=(r=this.element.children(":first")).offset(),i={top:s.scrollTop(),right:s.width()+s.scrollLeft()},(n={top:o.top,right:o.left+r.width()}).top-i.top<0&&this.invertY(),n.right-i.right>0&&this.invertX(),this},i.prototype.resetOrientation=function(){return this.element.removeClass(this.classes.invert.x).removeClass(this.classes.invert.y),this},i.prototype.invertX=function(){return this.element.addClass(this.classes.invert.x),this},i.prototype.invertY=function(){return this.element.addClass(this.classes.invert.y),this},i.prototype.isInvertedY=function(){return this.element.hasClass(this.classes.invert.y)},i.prototype.isInvertedX=function(){return this.element.hasClass(this.classes.invert.x)},i}(),e.Editor=function(n){function o(e){this.onCancelButtonMouseover=R(this.onCancelButtonMouseover,this),this.processKeypress=R(this.processKeypress,this),this.submit=R(this.submit,this),this.load=R(this.load,this),this.hide=R(this.hide,this),this.show=R(this.show,this),o.__super__.constructor.call(this,t(this.html)[0],e),this.fields=[],this.annotation={}}return D(o,n),o.prototype.events={"form submit":"submit",".annotator-save click":"submit",".annotator-cancel click":"hide",".annotator-cancel mouseover":"onCancelButtonMouseover","textarea keydown":"processKeypress"},o.prototype.classes={hide:"annotator-hide",focus:"annotator-focus"},o.prototype.html='<div class="annotator-outer annotator-editor">\n  <form class="annotator-widget">\n    <ul class="annotator-listing"></ul>\n    <div class="annotator-controls">\n      <a href="#cancel" class="annotator-cancel">'+k("Cancel")+'</a>\n<a href="#save" class="annotator-save annotator-focus">'+k("Save")+"</a>\n    </div>\n  </form>\n</div>",o.prototype.options={},o.prototype.show=function(t){return e.Util.preventEventDefault(t),this.element.removeClass(this.classes.hide),this.element.find(".annotator-save").addClass(this.classes.focus),this.checkOrientation(),this.element.find(":input:first").focus(),this.setupDraggables(),this.publish("show")},o.prototype.hide=function(t){return e.Util.preventEventDefault(t),this.element.addClass(this.classes.hide),this.publish("hide")},o.prototype.load=function(t){var e,n,o,i;for(this.annotation=t,this.publish("load",[this.annotation]),n=0,o=(i=this.fields).length;n<o;n++)(e=i[n]).load(e.element,this.annotation);return this.show()},o.prototype.submit=function(t){var n,o,i,r;for(e.Util.preventEventDefault(t),o=0,i=(r=this.fields).length;o<i;o++)(n=r[o]).submit(n.element,this.annotation);return this.publish("save",[this.annotation]),this.hide()},o.prototype.addField=function(n){var o,i,r;switch(i=t.extend({id:"annotator-field-"+e.Util.uuid(),type:"input",label:"",load:function(){},submit:function(){}},n),r=null,o=t('<li class="annotator-item" />'),i.element=o[0],i.type){case"textarea":r=t("<textarea />");break;case"input":case"checkbox":r=t("<input />");break;case"select":r=t("<select />")}return o.append(r),r.attr({id:i.id,placeholder:i.label}),"checkbox"===i.type&&(r[0].type="checkbox",o.addClass("annotator-checkbox"),o.append(t("<label />",{for:i.id,html:i.label}))),this.element.find("ul:first").append(o),this.fields.push(i),i.element},o.prototype.checkOrientation=function(){var t,e;return o.__super__.checkOrientation.apply(this,arguments),e=this.element.find("ul"),t=this.element.find(".annotator-controls"),this.element.hasClass(this.classes.invert.y)?t.insertBefore(e):t.is(":first-child")&&t.insertAfter(e),this},o.prototype.processKeypress=function(t){return 27===t.keyCode?this.hide():13!==t.keyCode||t.shiftKey?void 0:this.submit()},o.prototype.onCancelButtonMouseover=function(){return this.element.find("."+this.classes.focus).removeClass(this.classes.focus)},o.prototype.setupDraggables=function(){var e,n,o,i,r,s,a,u,h,l,p;return this.element.find(".annotator-resize").remove(),(o=this.element.hasClass(this.classes.invert.y)?this.element.find(".annotator-item:last"):this.element.find(".annotator-item:first"))&&t('<span class="annotator-resize"></span>').appendTo(o),r=null,e=this.classes,i=this.element,l=null,h=i.find(".annotator-resize"),n=i.find(".annotator-controls"),p=!1,s=function(e){if(e.target===this)return r={element:this,top:e.pageY,left:e.pageX},l=i.find("textarea:first"),t(window).bind({"mouseup.annotator-editor-resize":u,"mousemove.annotator-editor-resize":a}),e.preventDefault()},u=function(){return r=null,t(window).unbind(".annotator-editor-resize")},a=function(t){var o,s,a,u,d;if(r&&!1===p)return o={top:t.pageY-r.top,left:t.pageX-r.left},r.element===h[0]?(u=l.outerHeight(),d=l.outerWidth(),s=i.hasClass(e.invert.x)?-1:1,a=i.hasClass(e.invert.y)?1:-1,l.height(u+o.top*a),l.width(d+o.left*s),l.outerHeight()!==u&&(r.top=t.pageY),l.outerWidth()!==d&&(r.left=t.pageX)):r.element===n[0]&&(i.css({top:parseInt(i.css("top"),10)+o.top,left:parseInt(i.css("left"),10)+o.left}),r.top=t.pageY,r.left=t.pageX),p=!0,setTimeout(function(){return p=!1},1e3/60)},h.bind("mousedown",s),n.bind("mousedown",s)},o}(e.Widget),e.Viewer=function(n){function i(e){this.onDeleteClick=R(this.onDeleteClick,this),this.onEditClick=R(this.onEditClick,this),this.load=R(this.load,this),this.hide=R(this.hide,this),this.show=R(this.show,this),i.__super__.constructor.call(this,t(this.html.element)[0],e),this.item=t(this.html.item)[0],this.fields=[],this.annotations=[]}return D(i,n),i.prototype.events={".annotator-edit click":"onEditClick",".annotator-delete click":"onDeleteClick"},i.prototype.classes={hide:"annotator-hide",showControls:"annotator-visible"},i.prototype.html={element:'<div class="annotator-outer annotator-viewer">\n  <ul class="annotator-widget annotator-listing"></ul>\n</div>',item:'<li class="annotator-annotation annotator-item">\n  <span class="annotator-controls">\n    <a href="#" title="View as webpage" class="annotator-link">View as webpage</a>\n    <button title="Edit" class="annotator-edit">Edit</button>\n    <button title="Delete" class="annotator-delete">Delete</button>\n  </span>\n</li>'},i.prototype.options={readOnly:!1},i.prototype.show=function(t){var n,o;return e.Util.preventEventDefault(t),n=this.element.find(".annotator-controls").addClass(this.classes.showControls),setTimeout((o=this,function(){return n.removeClass(o.classes.showControls)}),500),this.element.removeClass(this.classes.hide),this.checkOrientation().publish("show")},i.prototype.isShown=function(){return!this.element.hasClass(this.classes.hide)},i.prototype.hide=function(t){return e.Util.preventEventDefault(t),this.element.addClass(this.classes.hide),this.publish("hide")},i.prototype.load=function(e){var n,i,r,s,a,u,h,l,p,d,c,f,g,m,y,v,_;for(this.annotations=e||[],c=this.element.find("ul:first").empty(),f=0,m=(v=this.annotations).length;f<m;f++)for(n=v[f],p=(r=(l=t(this.item).clone().appendTo(c).data("annotation",n)).find(".annotator-controls")).find(".annotator-link"),a=r.find(".annotator-edit"),s=r.find(".annotator-delete"),0===(d=new o(n.links||[]).get("alternate",{type:"text/html"})).length||null==d[0].href?p.remove():p.attr("href",d[0].href),this.options.readOnly?(a.remove(),s.remove()):i={showEdit:function(){return a.removeAttr("disabled")},hideEdit:function(){return a.attr("disabled","disabled")},showDelete:function(){return s.removeAttr("disabled")},hideDelete:function(){return s.attr("disabled","disabled")}},g=0,y=(_=this.fields).length;g<y;g++)h=_[g],u=t(h.element).clone().appendTo(l)[0],h.load(u,n,i);return this.publish("load",[this.annotations]),this.show()},i.prototype.addField=function(e){var n;return(n=t.extend({load:function(){}},e)).element=t("<div />")[0],this.fields.push(n),n.element,this},i.prototype.onEditClick=function(t){return this.onButtonClick(t,"edit")},i.prototype.onDeleteClick=function(t){if(1==confirm("Are you sure you want to delete this annotation?"))return this.onButtonClick(t,"delete")},i.prototype.onButtonClick=function(e,n){var o;return o=t(e.target).parents(".annotator-annotation"),this.publish(n,[o.data("annotation")])},i}(e.Widget),o=function(){function e(t){this.data=t}return e.prototype.get=function(e,n){var o,i,r,s,a,u,h;for(null==n&&(n={}),n=t.extend({},n,{rel:e}),r=function(){var t;for(i in t=[],n)P.call(n,i)&&(n[i],t.push(i));return t}(),h=[],s=0,a=(u=this.data).length;s<a;s++)o=u[s],r.reduce(function(t,e){return t&&o[e]===n[e]},!0)&&h.push(o);return h},e}(),(e=e||{}).Notification=function(o){function i(e){this.hide=R(this.hide,this),this.show=R(this.show,this),i.__super__.constructor.call(this,t(this.options.html).appendTo(document.body)[0],e)}return D(i,n),i.prototype.events={click:"hide"},i.prototype.options={html:"<div class='annotator-notice'></div>",classes:{show:"annotator-notice-show",info:"annotator-notice-info",success:"annotator-notice-success",error:"annotator-notice-error"}},i.prototype.show=function(n,o){return null==o&&(o=e.Notification.INFO),this.currentStatus=o,t(this.element).addClass(this.options.classes.show).addClass(this.options.classes[this.currentStatus]).html(r.escape(n||"")),setTimeout(this.hide,5e3),this},i.prototype.hide=function(){return null==this.currentStatus&&(this.currentStatus=e.Notification.INFO),t(this.element).removeClass(this.options.classes.show).removeClass(this.options.classes[this.currentStatus]),this},i}(),e.Notification.INFO="info",e.Notification.SUCCESS="success",e.Notification.ERROR="error",t(function(){var t;return t=new e.Notification,e.showNotification=t.show,e.hideNotification=t.hide}),e.Plugin.Unsupported=function(n){function o(){return o.__super__.constructor.apply(this,arguments)}return D(o,n),o.prototype.options={message:e._t("Sorry your current browser does not support the Annotator")},o.prototype.pluginInit=function(){if(!e.supported())return t((n=this,function(){if(e.showNotification(n.options.message),void 0===window.XMLHttpRequest&&void 0!==ActiveXObject)return t("html").addClass("ie6")}));var n},o}(e.Plugin),u=function(t){var e,n,o,i,r;return"([0-9]{4})(-([0-9]{2})(-([0-9]{2})(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(\\.([0-9]+))?)?(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?",e=t.match(new RegExp("([0-9]{4})(-([0-9]{2})(-([0-9]{2})(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(\\.([0-9]+))?)?(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?")),o=0,n=new Date(e[1],0,1),e[3]&&n.setMonth(e[3]-1),e[5]&&n.setDate(e[5]),e[7]&&n.setHours(e[7]),e[8]&&n.setMinutes(e[8]),e[10]&&n.setSeconds(e[10]),e[12]&&n.setMilliseconds(1e3*Number("0."+e[12])),e[14]&&(o=60*Number(e[16])+Number(e[17]),o*=null!=(r="-"===e[15])?r:{1:-1}),o-=n.getTimezoneOffset(),i=Number(n)+60*o*1e3,n.setTime(Number(i)),n},s=function(t){var e,n,o,i,r,s,a,u,h,l;if("undefined"!=typeof atob&&null!==atob)return atob(t);if(n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",s=0,e=0,"",l=[],!t)return t;for(t+="";s<t.length;)a=(o=n.indexOf(t.charAt(s++))<<18|n.indexOf(t.charAt(s++))<<12|(i=n.indexOf(t.charAt(s++)))<<6|(r=n.indexOf(t.charAt(s++))))>>16&255,u=o>>8&255,h=255&o,l[e++]=64===i?String.fromCharCode(a):64===r?String.fromCharCode(a,u):String.fromCharCode(a,u,h);return l.join("")},a=function(t){var e,n,o;if(0!==(e=t.length%4))for(n=0,o=4-e;0<=o?n<o:n>o;0<=o?++n:--n)t+="=";return t=(t=t.replace(/-/g,"+")).replace(/_/g,"/"),s(t)},m=function(t){var e,n;return(n=t.split("."))[0],e=n[1],n[2],JSON.parse(a(e))},e.Plugin.Auth=function(n){function o(t,e){o.__super__.constructor.apply(this,arguments),this.waitingForToken=[],this.options.token?this.setToken(this.options.token):this.requestToken()}return D(o,n),o.prototype.options={token:null,tokenUrl:"/auth/token",autoFetch:!0},o.prototype.requestToken=function(){return this.requestInProgress=!0,t.ajax({url:this.options.tokenUrl,dataType:"text",xhrFields:{withCredentials:!0}}).done((n=this,function(t,e,o){return n.setToken(t)})).fail(function(t,n,o){var i;return i=e._t("Your session has expired; please log in again."),console.error(i+" "+o,t),e.showNotification(i,e.Notification.ERROR)}).always(function(t){return function(){return t.requestInProgress=!1}}(this));var n},o.prototype.setToken=function(t){var n,o;if(this.token=t,this._unsafeToken=m(t),this.haveValidToken()){for(this.options.autoFetch&&(this.refreshTimeout=setTimeout((o=this,function(){return o.requestToken()}),1e3*(this.timeToExpiry()-2))),this.updateHeaders(),n=[];this.waitingForToken.length>0;)n.push(this.waitingForToken.pop()(this._unsafeToken));return n}if(console.warn(e._t("Didn't get a valid token.")),this.options.autoFetch)return console.warn(e._t("Getting a new token in 10s.")),setTimeout(function(t){return function(){return t.requestToken()}}(this),1e4)},o.prototype.haveValidToken=function(){return!!(this._unsafeToken&&this._unsafeToken.issuedAt&&this._unsafeToken.ttl&&this._unsafeToken.consumerKey&&this.timeToExpiry()>0)},o.prototype.timeToExpiry=function(){var t,e;return t=(new Date).getTime()/1e3,(e=u(this._unsafeToken.issuedAt).getTime()/1e3+this._unsafeToken.ttl-t)>0?e:0},o.prototype.updateHeaders=function(){var e;return e=this.element.data("annotator:headers"),this.element.data("annotator:headers",t.extend(e,{"x-annotator-auth-token":this.token}))},o.prototype.withToken=function(t){if(null!=t)return this.haveValidToken()?t(this._unsafeToken):(this.waitingForToken.push(t),this.requestInProgress?void 0:this.requestToken())},o}(e.Plugin),e.Plugin.Store=function(n){function o(t,e){this._onError=R(this._onError,this),this._onLoadAnnotationsFromSearch=R(this._onLoadAnnotationsFromSearch,this),this._onLoadAnnotations=R(this._onLoadAnnotations,this),this._getAnnotations=R(this._getAnnotations,this),o.__super__.constructor.apply(this,arguments),this.annotations=[]}return D(o,n),o.prototype.events={annotationCreated:"annotationCreated",annotationDeleted:"annotationDeleted",annotationUpdated:"annotationUpdated"},o.prototype.options={annotationData:{},emulateHTTP:!1,loadFromSearch:!1,prefix:"/store",urls:{create:"/annotations",read:"/annotations/:id",update:"/annotations/:id",destroy:"/annotations/:id",search:"/search"}},o.prototype.pluginInit=function(){if(e.supported())return this.annotator.plugins.Auth?this.annotator.plugins.Auth.withToken(this._getAnnotations):this._getAnnotations()},o.prototype._getAnnotations=function(){return this.options.loadFromSearch?this.loadAnnotationsFromSearch(this.options.loadFromSearch):this.loadAnnotations()},o.prototype.annotationCreated=function(t){return H.call(this.annotations,t)<0?(this.registerAnnotation(t),this._apiRequest("create",t,(n=this,function(o){return null==o.id&&console.warn(e._t("Warning: No ID returned from server for annotation "),t),n.updateAnnotation(t,o)}))):this.updateAnnotation(t,{});var n},o.prototype.annotationUpdated=function(t){if(H.call(this.annotations,t)>=0)return this._apiRequest("update",t,(e=this,function(n){return e.updateAnnotation(t,n)}));var e},o.prototype.annotationDeleted=function(t){if(H.call(this.annotations,t)>=0)return this._apiRequest("destroy",t,(e=this,function(){return e.unregisterAnnotation(t)}));var e},o.prototype.registerAnnotation=function(t){return this.annotations.push(t)},o.prototype.unregisterAnnotation=function(t){return this.annotations.splice(this.annotations.indexOf(t),1)},o.prototype.updateAnnotation=function(n,o){return H.call(this.annotations,n)<0?console.error(e._t("Trying to update unregistered annotation!")):t.extend(n,o),t(n.highlights).data("annotation",n)},o.prototype.loadAnnotations=function(){return this._apiRequest("read",null,this._onLoadAnnotations)},o.prototype._onLoadAnnotations=function(t){var e,n,o,i,r,s,a,u,h;for(null==t&&(t=[]),o={},r=0,a=(h=this.annotations).length;r<a;r++)o[(e=h[r]).id]=e;for(i=[],s=0,u=t.length;s<u;s++)o[(e=t[s]).id]?(n=o[e.id],this.updateAnnotation(n,e)):i.push(e);return this.annotations=this.annotations.concat(i),this.annotator.loadAnnotations(i.slice())},o.prototype.loadAnnotationsFromSearch=function(t){return this._apiRequest("search",t,this._onLoadAnnotationsFromSearch)},o.prototype._onLoadAnnotationsFromSearch=function(t){return null==t&&(t={}),this._onLoadAnnotations(t.rows||[])},o.prototype.dumpAnnotations=function(){var t,e,n,o,i;for(i=[],e=0,n=(o=this.annotations).length;e<n;e++)t=o[e],i.push(JSON.parse(this._dataFor(t)));return i},o.prototype._apiRequest=function(e,n,o){var i,r,s,a;return i=n&&n.id,a=this._urlFor(e,i),r=this._apiRequestOptions(e,n,o),(s=t.ajax(a,r))._id=i,s._action=e,s},o.prototype._apiRequestOptions=function(e,n,o){var i,r,s;return s={type:r=this._methodFor(e),headers:this.element.data("annotator:headers"),dataType:"json",success:o||function(){},error:this._onError},!this.options.emulateHTTP||"PUT"!==r&&"DELETE"!==r||(s.headers=t.extend(s.headers,{"X-HTTP-Method-Override":r}),s.type="POST"),"search"===e?s=t.extend(s,{data:n}):(i=n&&this._dataFor(n),this.options.emulateJSON?(s.data={json:i},this.options.emulateHTTP&&(s.data._method=r),s):s=t.extend(s,{data:i,contentType:"application/json; charset=utf-8"}))},o.prototype._urlFor=function(t,e){var n;return n=null!=this.options.prefix?this.options.prefix:"",n=(n=(n+=this.options.urls[t]).replace(/\/:id/,null!=e?"/"+e:"")).replace(/:id/,null!=e?e:"")},o.prototype._methodFor=function(t){return{create:"POST",read:"GET",update:"PUT",destroy:"DELETE",search:"GET"}[t]},o.prototype._dataFor=function(e){var n,o;return o=e.highlights,delete e.highlights,t.extend(e,this.options.annotationData),n=JSON.stringify(e),o&&(e.highlights=o),n},o.prototype._onError=function(t){var n,o;switch(n=t._action,o=e._t("Sorry we could not ")+n+e._t(" this annotation"),"search"===t._action?o=e._t("Sorry we could not search the store for annotations"):"read"!==t._action||t._id||(o=e._t("Sorry we could not ")+n+e._t(" the annotations from the store")),t.status){case 401:o=e._t("Sorry you are not allowed to ")+n+e._t(" this annotation");break;case 404:o=e._t("Sorry we could not connect to the annotations store");break;case 500:o=e._t("Sorry something went wrong with the annotation store")}return e.showNotification(o,e.Notification.ERROR),console.error(e._t("API request failed:")+" '"+t.status+"'")},o}(e.Plugin),e.Plugin.Permissions=function(n){function o(t,e){this._setAuthFromToken=R(this._setAuthFromToken,this),this.updateViewer=R(this.updateViewer,this),this.updateAnnotationPermissions=R(this.updateAnnotationPermissions,this),this.updatePermissionsField=R(this.updatePermissionsField,this),this.addFieldsToAnnotation=R(this.addFieldsToAnnotation,this),o.__super__.constructor.apply(this,arguments),this.options.user&&(this.setUser(this.options.user),delete this.options.user)}return D(o,n),o.prototype.events={beforeAnnotationCreated:"addFieldsToAnnotation"},o.prototype.options={showViewPermissionsCheckbox:!0,showEditPermissionsCheckbox:!0,userId:function(t){return t},userString:function(t){return t},userAuthorize:function(t,e,n){var o,i,r,s;if(e.permissions){if(0===(i=e.permissions[t]||[]).length)return!0;for(r=0,s=i.length;r<s;r++)if(o=i[r],this.userId(n)===o)return!0;return!1}return!e.user||!!n&&this.userId(n)===this.userId(e.user)},user:"",permissions:{read:[],update:[],delete:[],admin:[]}},o.prototype.pluginInit=function(){var t,n,o;if(e.supported())return n=this,t=function(t,e){return function(o,i){return n[t].call(n,e,o,i)}},!this.user&&this.annotator.plugins.Auth&&this.annotator.plugins.Auth.withToken(this._setAuthFromToken),!0===this.options.showViewPermissionsCheckbox&&this.annotator.editor.addField({type:"checkbox",label:e._t("Allow anyone to <strong>view</strong> this annotation"),load:t("updatePermissionsField","read"),submit:t("updateAnnotationPermissions","read")}),!0===this.options.showEditPermissionsCheckbox&&this.annotator.editor.addField({type:"checkbox",label:e._t("Allow anyone to <strong>edit</strong> this annotation"),load:t("updatePermissionsField","update"),submit:t("updateAnnotationPermissions","update")}),this.annotator.viewer.addField({load:this.updateViewer}),this.annotator.plugins.Filter?this.annotator.plugins.Filter.addFilter({label:e._t("User"),property:"user",isFiltered:(o=this,function(t,e){var n,i,r,s;if(e=o.options.userString(e),!t||!e)return!1;for(i=0,r=(s=t.split(/\s*/)).length;i<r;i++)if(n=s[i],-1===e.indexOf(n))return!1;return!0})}):void 0},o.prototype.setUser=function(t){return this.user=t},o.prototype.addFieldsToAnnotation=function(t){if(t&&(t.permissions=this.options.permissions,this.user))return t.user=this.user},o.prototype.authorize=function(t,e,n){return void 0===n&&(n=this.user),!this.options.userAuthorize||this.options.userAuthorize.call(this.options,t,e,n)},o.prototype.updatePermissionsField=function(e,n,o){var i;return i=(n=t(n).show()).find("input").removeAttr("disabled"),this.authorize("admin",o)||n.hide(),this.authorize(e,o||{},null)?i.attr("checked","checked"):i.removeAttr("checked")},o.prototype.updateAnnotationPermissions=function(e,n,o){return o.permissions||(o.permissions=this.options.permissions),e+"-permissions",t(n).find("input").is(":checked")?o.permissions[e]=[]:o.permissions[e]=[this.options.userId(this.user)]},o.prototype.updateViewer=function(n,o,i){var r,s;if(n=t(n),s=this.options.userString(o.user),o.user&&s&&"string"==typeof s?(r=e.Util.escape(this.options.userString(o.user)),n.html(r).addClass("annotator-user")):n.remove(),i&&(this.authorize("update",o)||i.hideEdit(),!this.authorize("delete",o)))return i.hideDelete()},o.prototype._setAuthFromToken=function(t){return this.setUser(t.userId)},o}(e.Plugin),e.Plugin.AnnotateItPermissions=function(e){function n(){return this._setAuthFromToken=R(this._setAuthFromToken,this),this.updateAnnotationPermissions=R(this.updateAnnotationPermissions,this),this.updatePermissionsField=R(this.updatePermissionsField,this),this.addFieldsToAnnotation=R(this.addFieldsToAnnotation,this),n.__super__.constructor.apply(this,arguments)}return D(n,e),n.prototype.options={showViewPermissionsCheckbox:!0,showEditPermissionsCheckbox:!0,groups:{world:"group:__world__",authenticated:"group:__authenticated__",consumer:"group:__consumer__"},userId:function(t){return t.userId},userString:function(t){return t.userId},userAuthorize:function(t,e,n){var o,i,r,s,a;return o=(e.permissions||{})[t]||[],i=this.groups.world,H.call(o,i)>=0||null!=n&&null!=n.userId&&null!=n.consumerKey&&(n.userId===e.user&&n.consumerKey===e.consumer||(r=this.groups.authenticated,H.call(o,r)>=0||(n.consumerKey===e.consumer&&(s=this.groups.consumer,H.call(o,s)>=0)||(n.consumerKey===e.consumer&&(a=n.userId,H.call(o,a)>=0)||!(n.consumerKey!==e.consumer||!n.admin)))))},permissions:{read:["group:__world__"],update:[],delete:[],admin:[]}},n.prototype.addFieldsToAnnotation=function(t){if(t&&(t.permissions=this.options.permissions,this.user))return t.user=this.user.userId,t.consumer=this.user.consumerKey},n.prototype.updatePermissionsField=function(e,n,o){var i;return i=(n=t(n).show()).find("input").removeAttr("disabled"),this.authorize("admin",o)||n.hide(),this.user&&this.authorize(e,o||{},{userId:"__nonexistentuser__",consumerKey:this.user.consumerKey})?i.attr("checked","checked"):i.removeAttr("checked")},n.prototype.updateAnnotationPermissions=function(e,n,o){return o.permissions||(o.permissions=this.options.permissions),e+"-permissions",t(n).find("input").is(":checked")?o.permissions[e]=["read"===e?this.options.groups.world:this.options.groups.consumer]:o.permissions[e]=[]},n.prototype._setAuthFromToken=function(t){return this.setUser(t)},n}(e.Plugin.Permissions),e.Plugin.Filter=function(n){function o(e,n){var i;this._onPreviousClick=R(this._onPreviousClick,this),this._onNextClick=R(this._onNextClick,this),this._onFilterKeyup=R(this._onFilterKeyup,this),this._onFilterBlur=R(this._onFilterBlur,this),this._onFilterFocus=R(this._onFilterFocus,this),this.updateHighlights=R(this.updateHighlights,this),e=t(this.html.element).appendTo((null!=n?n.appendTo:void 0)||this.options.appendTo),o.__super__.constructor.call(this,e,n),(i=this.options).filters||(i.filters=[]),this.filter=t(this.html.filter),this.filters=[],this.current=0}return D(o,n),o.prototype.events={".annotator-filter-property input focus":"_onFilterFocus",".annotator-filter-property input blur":"_onFilterBlur",".annotator-filter-property input keyup":"_onFilterKeyup",".annotator-filter-previous click":"_onPreviousClick",".annotator-filter-next click":"_onNextClick",".annotator-filter-clear click":"_onClearClick"},o.prototype.classes={active:"annotator-filter-active",hl:{hide:"annotator-hl-filtered",active:"annotator-hl-active"}},o.prototype.html={element:'<div class="annotator-filter">\n  <strong>'+e._t("Navigate:")+'</strong>\n<span class="annotator-filter-navigation">\n  <button class="annotator-filter-previous">'+e._t("Previous")+'</button>\n<button class="annotator-filter-next">'+e._t("Next")+"</button>\n</span>\n<strong>"+e._t("Filter by:")+"</strong>\n</div>",filter:'<span class="annotator-filter-property">\n  <label></label>\n  <input/>\n  <button class="annotator-filter-clear">'+e._t("Clear")+"</button>\n</span>"},o.prototype.options={appendTo:"body",filters:[],addAnnotationFilter:!0,isFiltered:function(t,e){var n,o,i,r;if(!t||!e)return!1;for(o=0,i=(r=t.split(/\s+/)).length;o<i;o++)if(n=r[o],-1===e.indexOf(n))return!1;return!0}},o.prototype.pluginInit=function(){var t,n,o,i;for(n=0,o=(i=this.options.filters).length;n<o;n++)t=i[n],this.addFilter(t);if(this.updateHighlights(),this._setupListeners()._insertSpacer(),!0===this.options.addAnnotationFilter)return this.addFilter({label:e._t("Annotation"),property:"text"})},o.prototype.destroy=function(){var e,n;return o.__super__.destroy.apply(this,arguments),n=t("html"),e=parseInt(n.css("padding-top"),10)||0,n.css("padding-top",e-this.element.outerHeight()),this.element.remove()},o.prototype._insertSpacer=function(){var e,n;return n=t("html"),e=parseInt(n.css("padding-top"),10)||0,n.css("padding-top",e+this.element.outerHeight()),this},o.prototype._setupListeners=function(){var t,e,n,o;for(n=0,o=(e=["annotationsLoaded","annotationCreated","annotationUpdated","annotationDeleted"]).length;n<o;n++)t=e[n],this.annotator.subscribe(t,this.updateHighlights);return this},o.prototype.addFilter=function(n){var o,i;return i=t.extend({label:"",property:"",isFiltered:this.options.isFiltered},n),function(){var t,e,n,r;for(r=[],t=0,e=(n=this.filters).length;t<e;t++)(o=n[t]).property===i.property&&r.push(o);return r}.call(this).length||(i.id="annotator-filter-"+i.property,i.annotations=[],i.element=this.filter.clone().appendTo(this.element),i.element.find("label").html(i.label).attr("for",i.id),i.element.find("input").attr({id:i.id,placeholder:e._t("Filter by ")+i.label+"…"}),i.element.find("button").hide(),i.element.data("filter",i),this.filters.push(i)),this},o.prototype.updateFilter=function(e){var n,o,i,r,s,a,u;if(e.annotations=[],this.updateHighlights(),this.resetHighlights(),i=t.trim(e.element.find("input").val())){for(o=this.highlights.map(function(){return t(this).data("annotation")}),s=0,a=(u=t.makeArray(o)).length;s<a;s++)r=(n=u[s])[e.property],e.isFiltered(i,r)&&e.annotations.push(n);return this.filterHighlights()}},o.prototype.updateHighlights=function(){return this.highlights=this.annotator.element.find(".annotator-hl:visible"),this.filtered=this.highlights.not(this.classes.hl.hide)},o.prototype.filterHighlights=function(){var e,n,o,i,r,s,a,u,h,l;for(e=t.grep(this.filters,function(t){return!!t.annotations.length}),i=(null!=(l=e[0])?l.annotations:void 0)||[],e.length>1&&(o=[],t.each(e,function(){return t.merge(o,this.annotations)}),a=[],i=[],t.each(o,function(){return-1===t.inArray(this,a)?a.push(this):i.push(this)})),r=this.highlights,s=u=0,h=i.length;u<h;s=++u)n=i[s],r=r.not(n.highlights);return r.addClass(this.classes.hl.hide),this.filtered=this.highlights.not(this.classes.hl.hide),this},o.prototype.resetHighlights=function(){return this.highlights.removeClass(this.classes.hl.hide),this.filtered=this.highlights,this},o.prototype._onFilterFocus=function(e){var n;return(n=t(e.target)).parent().addClass(this.classes.active),n.next("button").show()},o.prototype._onFilterBlur=function(e){var n;if(!e.target.value)return(n=t(e.target)).parent().removeClass(this.classes.active),n.next("button").hide()},o.prototype._onFilterKeyup=function(e){var n;if(n=t(e.target).parent().data("filter"))return this.updateFilter(n)},o.prototype._findNextHighlight=function(t){var e,n,o,i,r,s,a,u;return this.highlights.length?(s=t?0:-1,u=t?-1:0,a=t?"lt":"gt",(o=(e=this.highlights.not("."+this.classes.hl.hide)).filter("."+this.classes.hl.active)).length||(o=e.eq(s)),n=o.data("annotation"),i=e.index(o[0]),(r=e.filter(":"+a+"("+i+")").not(n.highlights).eq(u)).length||(r=e.eq(u)),this._scrollToHighlight(r.data("annotation").highlights)):this},o.prototype._onNextClick=function(t){return this._findNextHighlight()},o.prototype._onPreviousClick=function(t){return this._findNextHighlight(!0)},o.prototype._scrollToHighlight=function(e){return e=t(e),this.highlights.removeClass(this.classes.hl.active),e.addClass(this.classes.hl.active),t("html, body").animate({scrollTop:e.offset().top-(this.element.height()+20)},150)},o.prototype._onClearClick=function(e){return t(e.target).prev("input").val("").keyup().blur()},o}(e.Plugin),e.Plugin.Markdown=function(n){function o(t,n){this.updateTextField=R(this.updateTextField,this),null!=("undefined"!=typeof Showdown&&null!==Showdown?Showdown.converter:void 0)?(o.__super__.constructor.apply(this,arguments),this.converter=new Showdown.converter):console.error(e._t("To use the Markdown plugin, you must include Showdown into the page first."))}return D(o,n),o.prototype.events={annotationViewerTextField:"updateTextField"},o.prototype.updateTextField=function(n,o){var i;return i=e.Util.escape(o.text||""),t(n).html(this.convert(i))},o.prototype.convert=function(t){return this.converter.makeHtml(t)},o}(e.Plugin),e.Plugin.Tags=function(n){function o(){return this.setAnnotationTags=R(this.setAnnotationTags,this),this.updateField=R(this.updateField,this),o.__super__.constructor.apply(this,arguments)}return D(o,n),o.prototype.options={parseTags:function(e){var n;return n=[],(e=t.trim(e))&&(n=e.split(/\s+/)),n},stringifyTags:function(t){return t.join(" ")}},o.prototype.field=null,o.prototype.input=null,o.prototype.pluginInit=function(){if(e.supported())return this.field=this.annotator.editor.addField({label:e._t("Add some tags here")+"…",load:this.updateField,submit:this.setAnnotationTags}),this.annotator.viewer.addField({load:this.updateViewer}),this.annotator.plugins.Filter&&this.annotator.plugins.Filter.addFilter({label:e._t("Tag"),property:"tags",isFiltered:e.Plugin.Tags.filterCallback}),this.input=t(this.field).find(":input")},o.prototype.parseTags=function(t){return this.options.parseTags(t)},o.prototype.stringifyTags=function(t){return this.options.stringifyTags(t)},o.prototype.updateField=function(t,e){var n;return n="",e.tags&&(n=this.stringifyTags(e.tags)),this.input.val(n)},o.prototype.setAnnotationTags=function(t,e){return e.tags=this.parseTags(this.input.val())},o.prototype.updateViewer=function(n,o){return n=t(n),o.tags&&t.isArray(o.tags)&&o.tags.length?n.addClass("annotator-tags").html(function(){return t.map(o.tags,function(t){return'<span class="annotator-tag">'+e.Util.escape(t)+"</span>"}).join(" ")}):n.remove()},o}(e.Plugin),e.Plugin.Tags.filterCallback=function(t,e){var n,o,i,r,s,a,u;if(null==e&&(e=[]),i=0,o=[],t)for(r=0,a=(o=t.split(/\s+/g)).length;r<a;r++)if(n=o[r],e.length)for(s=0,u=e.length;s<u;s++)-1!==e[s].indexOf(n)&&(i+=1);return i===o.length},e.prototype.setupPlugins=function(n,o){var i,r,s,a,u,h,l,p;for(i in null==n&&(n={}),null==o&&(o={}),s=["Unsupported","Auth","Tags","Filter","Store","AnnotateItPermissions"],(u=e.Util.getGlobal()).Showdown&&s.push("Markdown"),a=u.location.href.split(/#|\?/).shift()||"",r={Tags:{},Filter:{filters:[{label:e._t("User"),property:"user"},{label:e._t("Tags"),property:"tags"}]},Auth:{tokenUrl:n.tokenUrl||"http://annotateit.org/api/token"},Store:{prefix:n.storeUrl||"http://annotateit.org/api",annotationData:{uri:a},loadFromSearch:{uri:a}}},o)P.call(o,i)&&(o[i],H.call(s,i)<0&&s.push(i));for(t.extend(!0,r,o),p=[],h=0,l=s.length;h<l;h++)(i=s[h])in r&&!r[i]?p.push(void 0):p.push(this.addPlugin(i,r[i]));return p}}).call(this);
