Widget=window.Widget||{},Widget.AnnotationRows=Backbone.Model.extend({defaults:{rows:null}}),Widget.Annotation=Backbone.Model.extend({initialize:function(t){this.set(t)},defaults:{user:null,quote:null,text:null,id:null}}),Widget.RemoteAnnotationList=Backbone.Collection.extend({model:Widget.Annotation,comparator:function(t){var e=5e12-moment(t.get("created")),i=t.get("title");if(!i){var n=t.get("uri");n&&(n=(n=n.split("/"))[n.length-1],i=documentList[n],t.set("title",i))}return t.get("title")+e},initialize:function(t,e,i){this.url=e+"/search",this.fetch({headers:{"x-annotator-auth-token":i},data:t,success:this.fetchSuccess,error:this.fetchError}),this.deferred=new $.Deferred,this.sort()},deferred:Function.constructor.prototype,fetchSuccess:function(t,e,i){console.log("ANNOTATION API CALL:",i.data),console.log("ANNOTATION RESPONSE:",t.models),t.deferred.resolve()},fetchError:function(t,e){throw console.log("ANNOTATION API ERROR:",e),new Error("Fetch did not get annotations from the API"+e)}}),Widget.AnnotationView=Backbone.View.extend({tagName:"li",className:"list-group-item",initialize:function(){this.commenttemplate=$("#user-comment-template").html(),this.highlighttemplate=$("#user-highlight-template").html(),this.mdconverter=new Showdown.converter,this.href="#full"+this.model.get("uuid")},render:function(){$(this.el).find(".highlight.comment img").addClass("thumbnail");var t=this.model.get("text"),e=this.model.get("quote"),i=this.model.get("updated");i&&this.model.set("formattedDate",window.formatDateTime(i));var n=this.model.get("uri");if(n){n=(n=n.split("/"))[n.length-1];var o=documentList[n];this.model.set("title",o)}var l=this.model.get("groups");return l&&0<l.length&&this.model.set("class",l[0]),""!==t&&null!==t?(this.mdConvert(),"<p>"===t.substring(0,3)&&"</p>"===t.slice(-4)&&(t=t.slice(3,-4)),this.model.set("text",t),$(this.el).html(Mustache.to_html(this.commenttemplate,this.model.toJSON()))):""!==e&&null!==e&&(this.model.set("quote",e),$(this.el).html(Mustache.to_html(this.highlighttemplate,this.model.toJSON()))),this},mdConvert:function(){var t=this.model.get("text");return""!==t&&null!==t&&this.model.set("text",this.mdconverter.makeHtml(t)),this}}),Widget.AnnotationListView=Backbone.View.extend({initialize:function(t){this.el=$("ul#"+t.container)},render:function(){this.$el.empty();var i=this;return this.collection.each(function(t){var e=new Widget.AnnotationView({model:t});i.el.append(e.render().el)}),i}}),Widget.App=Backbone.Router.extend({routes:{list:"listAnnotations"},listAnnotations:function(t,e,i,n){Widget.annotations=new Widget.RemoteAnnotationList(e,i,n);var o={container:t,collection:Widget.annotations},l=new Widget.AnnotationListView(o);Widget.annotations.deferred.done(function(){l.render();var t=l.el[0].id,e=$("#"+t),i=e.closest(".tab-pane").attr("id");e.closest(".panel").find(".nav-tabs a[href='#"+i+"']").find(".badge").text(l.collection.length)})}});